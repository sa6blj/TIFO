/*
 * A class to represent an image and calculate which
 * diods should light up given the current position.
 */

#include <stdint.h>
#include <stdbool.h>
#include "driverlib/sysctl.h"
#include "ImageHandler.h"
#include "OutputInterpreter.h"

#define IMG_LEN (imgs[currImg][0])

static int currImg = 1;
static int lastIndex = 0;

#define NUM_IMAGES 10

unsigned int *imgs[NUM_IMAGES] =
		{
			//"  TIFO!  "
			(unsigned int[])
			{44,0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
				0x0000, 0xc000, 0xc000, 0xffff, 0xc000, 0xc000, 0x0000,      	//T
				0x0000, 0xc003, 0xffff, 0xc003, 0x0000,                  		//I
				0x0000, 0xffff, 0xc0c0, 0xc0c0, 0xc0c0, 0xc0c0, 0xc000, 0x0000,	//F
				0x0000, 0x3ffc, 0x6006, 0xc003, 0xc003, 0x6006, 0x3ffc, 0x0000,	//O
				0x0000, 0xfff3, 0xfff3, 0x0000,                       			//!
				0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
			// "DATA"
			(unsigned int[])
			{55,0x00000000, 0xFFFFFFFF, 0xC0000003, 0xC0000003, 0xC0000003, 0xC0000003, 0xC0000003, 0x60000006, 0x60000006, 0x60000006, 0x3000000C, 0x3000000C, 0x18000018, 0x0F0000F0, 0x01FFFF80, 0x00000000, //D
				0x00000000, 0x01FFFFFF, 0x07030000, 0x1C030000, 0x70030000, 0xC0030000, 0xC0030000, 0x70030000, 0x1C030000, 0x07030000, 0x01FFFFFF, 0x00000000, //A
				0x00000000, 0xC0000000, 0xC0000000, 0xC0000000, 0xC0000000, 0xC0000000, 0xC0000000, 0xFFFFFFFF, 0xC0000000, 0xC0000000, 0xC0000000, 0xC0000000, 0xC0000000, 0xC0000000, 0x00000000, //T
				0x00000000, 0x01FFFFFF, 0x07030000, 0x1C030000, 0x70030000, 0xC0030000, 0xC0030000, 0x70030000, 0x1C030000, 0x07030000, 0x01FFFFFF, 0x00000000}, //A

			//Double Romb "<<>>"
			(unsigned int[])
			{32,0x00018000, 0x00024000, 0x00042000, 0x00081000, 0x00100800, 0x00200400, 0x00400200, 0x00800100, //<
				0x01018080, 0x02024040, 0x04042020, 0x08081010, 0x10100808, 0x20200404, 0x40400202, 0x80800101, //<<
				0x80800101, 0x40400202, 0x20200404, 0x10100808, 0x08081010, 0x04042020, 0x02024040, 0x01018080, //>>
				0x00800100, 0x00400200, 0x00200400, 0x00100800, 0x00081000, 0x00042000, 0x00024000, 0x00018000},//>
			//"  HEJA IT!  "
			(unsigned int[])
			{64,0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
					0x0000, 0xffffffff, 0x00018000, 0x00018000, 0xffffffff, 0x0000,                            //H
	                0x0000, 0xffffffff, 0xc0018003, 0xc0018003, 0xc0018003, 0xc0018003, 0xc0000003, 0x0000,    //E
	                0x0000, 0x0000001c, 0x00000006, 0x00000003, 0x00000003, 0xc0000006, 0xfffffffc, 0x0000,    //J
	                0x0000, 0x007fffff, 0x7fc18000, 0xc0018000, 0xc0018000, 0x7fc18000, 0x007fffff, 0x0000, //A
	                0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	                0x0000, 0xc0000003, 0xffffffff, 0xc0000003, 0x0000,                                      //I
	                0x0000, 0xc0000000, 0xc0000000, 0xffffffff, 0xc0000000, 0xc0000000, 0x0000,              //T
	                0x0000, 0xffffffe3, 0xffffffe3, 0x0000,                                                   //!
	                0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
			// Penis
			(unsigned int[])
			{41, 0x00000000, 0x98082000, 0x78002000, 0x18006000, 0x7801C000, 0x18006000, 0x38002000, 0x18002000,
				 0x08006000, 0x080FC000, 0x08086000, 0x080FC000, 0x08080000, 0x08080000, 0x08080000, 0x08080000,
				 0x08080000, 0x08080000, 0x08880000, 0x08880000, 0x08880000, 0x08C80000, 0x08480000, 0x08480000,
				 0x08480000, 0x08C80000, 0x08880000, 0x08880000, 0x08880000, 0x08C80000, 0x08080000, 0x0C080000,
				 0x180C0000, 0x10040000, 0x10040000, 0x10040000, 0x10040000, 0x08880000, 0x04800000, 0x03F00000,
				 0x00000000},
			// "SWOSH"
			(unsigned int[])
			{84, 0x00000000, 0x07F000E0, 0x1C0C0038, 0x3006000C, 0x60020006, 0x40030002, 0xC0010003, 0x80010001, 0x80010001, 0x80010001, 0xC0010003, 0x40018002, 0x60008006, 0x3000C00C, 0x1C007038, 0x07001FE0, 0x00000000, 0x00000000, 0xFFFFF800, 0x00000F00, 0x000001E0, 0x0000003C, 0x00000007, 0x00000007, 0x0000003C, 0x000001E0, 0x0FFFFF00, 0x000001E0, 0x0000003C, 0x00000007, 0x00000007, 0x0000003C, 0x000001E0, 0x00000F00, 0xFFFFF800, 0x00000000, 0x00000000, 0x000FFE00, 0x01F001E0, 0x07000038, 0x0C00000C, 0x58000006, 0x50000002, 0xF0000003, 0xA0000001, 0xA0000001, 0xF0000003, 0x50000002, 0x58000006, 0x0C00000C, 0x07000038, 0x07C003E0, 0x007FFE00, 0x00000000, 0x00000000, 0x07F000E0, 0x1C0C0038, 0x3006000C, 0x60020006, 0x40030002, 0xC0010003, 0x80010001, 0x80010001, 0x80010001, 0xC0010003, 0x40018002, 0x60008006, 0x3000C00C, 0x1C007038, 0x07001FE0, 0x00000000, 0x00000000, 0xFFFFFFFF, 0x00018000, 0x00018000, 0x00018000, 0x00018000, 0x00018000, 0x00018000, 0x00018000, 0x00018000, 0x00018000, 0xFFFFFFFF, 0x00000000},
			//Fuck you
			(unsigned int[])
			{18, 0x00000000, 0x003FFF80, 0x00400080, 0x00400080, 0x003F80FF, 0x00400000, 0x00400000, 0x7FFF8000, 0x90000000, 0x90000000, 0x7FFF8000, 0x00400000, 0x00400000, 0x003F80FF, 0x00400080, 0x00400080, 0x003FFF80, 0x00000000},


			//Smiley
			(unsigned int[])
			{34,0x0000,
				0x000ff000, 0x007ffe00, 0x00ffff00, 0x03fff3c0,	//Leftface
				0x07fff1e0, 0x0ffff8f0, 0x1ffff878, 0x1ffff878,
				0x3e03f83c, 0x7cf9f81e, 0x79fcf81e, 0x79bcf81e,
				0xfcf9f80f, 0xfe03f80f, 0xfffff80f, 0xfffff80f,
				0xfffff80f, 0xfffff80f, 0xfe03f80f, 0xfcf9f80f,	//Rightface
				0x79fcf81e, 0x79bcf81e, 0x7cf9f81e, 0x3e03f83c,
				0x1ffff878, 0x1ffff878, 0x0ffff8f0, 0x07fff1e0,
				0x03fff3c0, 0x00ffff00, 0x007ffe00, 0x000ff000,
				0x0000},
			//Thumbs up
			(unsigned int[])
			{18,0x0000, 0x00fe, 0x00fe, 0x01ff, 0x03ff, 0x07ff, 0x0fff, 0x1fff, 0x7fff,
				0xffff, 0xffff, 0x73ff, 0x03ff, 0x03fe, 0x03fc, 0x01f0, 0x00c0, 0x0000},
			//Thumbs down
			(unsigned int[])
			{18,0x0000, 0x7f00, 0x7f00, 0xff80, 0xffc0, 0xffe0, 0xfff0, 0xfff8, 0xfffe,
				0xffff, 0xffff, 0xffce, 0xffc0, 0x7fc0, 0x3fc0, 0x0f80, 0x0300, 0x0000},
			//Football
			(unsigned int[])
			{34,0x0000,
				0x000ff000, 0x007f8e00, 0x00fe6100, 0x037818c0,
				0x04200420, 0x08200210, 0x102003a8, 0x102007e8,
				0x204007e4, 0x60400ff2, 0x60601ff2, 0x60f067fa,
				0xe1fd83e7, 0xfbfe01c1, 0xc7fc0081, 0xc3fc0081,
				0xc1f80081, 0x80f80101, 0x80e40101, 0x80820101,
				0x41010202, 0x41008f02, 0x42007f82, 0x22003f84,
				0x1c003ff8, 0x1f003f88, 0x0f81ff10, 0x07c60e20,
				0x03f802c0, 0x00c00100, 0x00700e00, 0x000ff000,
				0x0000}
		};

void initImageHandler(){
	initOutputs();
}

/*
 * This function determines which part of the image or message to print out.
 * Also sends the determined column to the updateOutputs function.
 */
void updateImage(float pos) {

	// Compute which column to print
	int currIndex = pos*IMG_LEN;

	// If index is out of range (lower), set index to first possible position
	if (currIndex < 0) {
		currIndex = 0;
	// If index is out of range (higher), set index to last possible position
	} else if (currIndex >= IMG_LEN) {
		currIndex = IMG_LEN - 1;
	}
	// If current index differs from last index
	if (currIndex != lastIndex) {
		// Set current index to last index
		lastIndex = currIndex;
		// Send current column to output
		updateOutputs(imgs[currImg][currIndex+1]); //First value is the length of the array
	}
}

void accelDrawer(int16_t val) {
	int nbrOfLights = (((float)val)/32767)*16;
	int pixels = 0;
	int i = (nbrOfLights<0 ? -nbrOfLights : nbrOfLights);
	for(; i>0;i--) {
		if (nbrOfLights<0) {
			pixels <<= 1;
			pixels |= 0x10000;
		} else {
			pixels >>= 1;
			pixels |= 0x8000;
		}
	}
	updateOutputs(pixels);
}

void showImgNbr() {
	updateOutputs(currImg);
}

void nextImage() {
	currImg = (currImg+1)%NUM_IMAGES;
}

void previousImage() {
	currImg = (currImg+NUM_IMAGES-1)%NUM_IMAGES;
}
